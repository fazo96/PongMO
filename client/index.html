<html>
<head><title>Pong</title></head>
<body>
<div id="game"></div>
<script src="/bower_components/crafty/dist/crafty-min.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script type="text/javascript">
var paused = true;
var player = -1;

Crafty.init(600, 300, document.getElementById('game'));
Crafty.background('rgb(127,127,127)');
//Paddles
var p1 = Crafty.e("Paddle, 2D, DOM, Color, Multiway")
    .color('rgb(255,0,0)')
    .attr({ x: 20, y: 100, w: 10, h: 100 });
    //.multiway(4, { W: -90, S: 90 });
var p2 = Crafty.e("Paddle, 2D, DOM, Color, Multiway")
    .color('rgb(0,255,0)')
    .attr({ x: 580, y: 100, w: 10, h: 100 });
    //.multiway(4, { UP_ARROW: -90, DOWN_ARROW: 90 });

//Score boards
Crafty.e("LeftPoints, DOM, 2D, Text")
    .attr({ x: 20, y: 20, w: 100, h: 20, points: 0 })
    .text("0 Points");
Crafty.e("RightPoints, DOM, 2D, Text")
    .attr({ x: 515, y: 20, w: 100, h: 20, points: 0 })
    .text("0 Points");

var socket = io.connect('http://localhost:3000');

socket.on('connection',function(){
    console.log("connected");
});

socket.on('player',function(num){
    console.log('Player: '+num);
    player = num;
    var p;
    if(player == 1) p = p1;
    else if (player == 2) p = p2;
    if(player == 1 || player == 2){
        p.multiway(4, { UP_ARROW: -90, DOWN_ARROW: 90 });
        p.bind('Move',function(){
            socket.emit('move',p.y);
        })
    }
});

//Ball
var ball = Crafty.e("2D, DOM, Color, Collision")
    .color('rgb(0,0,255)')
    .attr({ x: 300, y: 150, w: 10, h: 10,
            dX: Crafty.math.randomInt(2, 5),
            dY: Crafty.math.randomInt(2, 5) })
    .bind('EnterFrame', function () {
        //hit floor or roof
        if (this.y <= 0 || this.y >= 290){
            if(player==1){
                this.dY *= -1;
                socket.emit('ball',{x : this.x, y: this.y, dX: this.dX, dY: this.dY });
                console.log('sent ball pos');
            }
        }
        if (this.x > 600) {
            this.x = 300;
            Crafty("LeftPoints").each(function () {
                this.text(++this.points + " Points") });
        }
        if (this.x < 10) {
            this.x = 300;
            Crafty("RightPoints").each(function () {
                this.text(++this.points + " Points") });
        }
        if(!paused){
            this.x += this.dX;
            this.y += this.dY;
        }
    })
    .onHit('Paddle', function () {
    if(player==1){
        this.dX *= -1;
        socket.emit('ball',{x : this.x, y: this.y, dX: this.dX, dY: this.dY });
        console.log('sent ball pos');
    }
});

socket.on('ball', function(b){
    if(player != 1){
        ball.x = b.x; ball.y = b.y;
        ball.dX = b.dX; ball.dY = b.dY;
        console.log("received ball data");
    }
});

if(player!=1)socket.on('move1',function(pos){
    p1.y = pos;
    console.log("Received paddle1 pos: "+pos);
});

if(player!=2)socket.on('move2',function(pos){
    p2.y = pos;
    console.log("Received paddle2 pos: "+pos);
});

socket.on('status',function(num){
    paused = (num==0);
    console.log("Game is now "+(paused?"paused":"resumed"));
});

</script>
</body>
</html>
